---
layout: post
title: Lab 08 Emulate FreeRTOS
date: 2023-09-01 00:00:00
---
<!-- more -->
##### This lab is mainly from the [QEMU Web](https://www.qemu.org/) and [FreeRTOS](https://www.freertos.org/freertos-on-qemu-mps2-an385-model.html)

## FreeRTOS on QEMU mps2-an385 Model

For FreeRTOS project, we recommend a good tutorial video "introduction to rtos with shawn hymel". You can get the slides from https://github.com/ShawnHymel/introduction-to-rtos. Also, you can search the video on Bilibili: [Shawn Hymel Presents: Introduction to RTOS](https://www.bilibili.com/video/BV1QX4y157Tb/?share_source=copy_web&vd_source=1063c13ea612bd7b961046f88255ebd3).

This lab documents a FreeRTOS kernel demo that targets the Arm Cortex-M3 [mps2-an385 QEMU](https://qemu.readthedocs.io/en/v7.0.0/system/arm/mps2.html) model. Preconfigured build projects are provided for [arm-none-eabi-gcc](https://developer.arm.com/tools-and-software/open-source-software/developer-tools/gnu-toolchain/gnu-rm/downloads) (GNU GCC) compilers. The GCC project uses a simple makefile that can be built from the command line or the provided [Eclipse CDT IDE](https://www.eclipse.org/cdt/downloads.php) project.

#### Source Code Organisation

The FreeRTOS distribution available from this website site contains the source files for all the FreeRTOS ports, and the projects for all the FreeRTOS demo applications. It therefore contains many more files than are required to use the Cortex-M3 mps2-an385 QEMU demo. See the [Source Code Organization](https://www.freertos.org/a00017.html) section for a description of the directory structure and information on creating a new FreeRTOS project.

The makefile that builds the project using the `arm-none-eabi-gcc` (GNU GCC) compiler, and the Eclipse project that builds the same makefile, are both located in the FreeRTOS/Demo/CORTEX\_MPS2\_QEMU\_IAR\_GCC/build/gcc directory.

* * *
Task: 
-----------
Our target is running a FreeRTOS kernel demo that targets the Arm Cortex-M3 mps2-an385 QEMU model. The demo projects provide both the simple blinky and comprehensive test/demo configurations described on the [FreeRTOS Demos Applications](https://www.freertos.org/a00102.html) documentation page. Specific to the demo documented on this page, the "check" task periodically prints a message in the following format:

    StatusMessageString : aaaa (bb)

Where `StatusMessageString` is a descriptive text string, `aaaa` is the RTOS tick count, and `bb` is the number of times the application detected interrupts becoming nested.  


#### You can build and execute the demo application in one of the following two approaches:

##### A. Building and executing the demo application - GCC Makefile

1.  Ensure both the [arm-none-eabi-gcc](https://developer.arm.com/tools-and-software/open-source-software/developer-tools/gnu-toolchain/gnu-rm/downloads) compiler and GNU make utility are installed on your host machine. For Windows users, the [GNUmake for Windows](https://gnuwin32.sourceforge.net/downlinks/make.php) is what you need. For Mac users, having `make` is easy using *brew* or *macport* system.
    
2.  Open FreeRTOS/Demo/CORTEX\_MPS2\_QEMU\_IAR\_GCC/main.c, and set mainCREATE\_SIMPLE\_BLINKY\_DEMO\_ONLY to generate either the [simply blinky demo](https://www.freertos.org/a00102.html#simple_blinky_demo), or the [comprehensive test and demo](https://www.freertos.org/a00102.html#comprehensive_demo) application, as required.
    
3.  Open a command prompt and navigate to the FreeRTOS/Demo/CORTEX\_MPS2\_QEMU\_IAR\_GCC/build/gcc directory.
    
4.  Type `make` in the command prompt. The project should build without any compiler errors or warnings. Hint: Use the "-j" parameter to speed the compilation by using more cores on your host computer. For example, if you have four cores available you can build four C files at once by entering "make -j4". A successful build creates the elf file FreeRTOS/Demo/CORTEX\_MPS2\_QEMU\_IAR\_GCC/build/gcc/output/RTOSDemo.out.
    
5.  Ensure QEMU is installed on your host computer. Start QEMU with the following command line, replacing [path-to] with the correct path to the RTOSDemo.out file generated by the GCC build.
    
```shell      
qemu-system-arm -machine mps2-an385 -cpu cortex-m3 -kernel [path-to]/RTOSDemo.out -monitor none -nographic -serial stdio -s -S
```      

Omit the "-s -S" if you just want to run the FreeRTOS application in QEMU without attaching the debugger.

6. You can now use `arm-none-eabi-gdb` to start a command line debug session following below steps.
      
    1.  Start GDB: navigate to the path to RTOSDemo.out, and start `arm-none-eabi-gdb`.
    
    ```shell    
    arm-none-eabi-gdb RTOSDemo.out
    ```    
    
    2.  Connect to QEMU: the default port for QEMU is 1234.
        
    ```
    (gdb) target remote localhost:1234
    ```
        
    3.  Set breakpoints.
        
    ```
    (gdb) break main
    ```
    
    4.  Start debugging.
   
    ```
    (gdb) continue
    ```    
        
        
    5.  Quit GDB.
        
    ```
    (gdb) quit
    ```    
        

##### B. Building and executing the demo application - Eclipse

1.  Ensure the [arm-none-eabi-gcc](https://developer.arm.com/tools-and-software/open-source-software/developer-tools/gnu-toolchain/gnu-rm/downloads) compiler and [Eclipse CDT IDE](https://www.eclipse.org/cdt/downloads.php) are installed on your host machine. It may be necessary to install the GNU make utility separately if it is not included with Eclipse.
    
2.  Select '**Import**' from the Eclipse '**File**' menu, then '**Existing Projects Into Workspace**' in the resultant window before clicking the Next button. ![]({{ site.baseurl }}/public/images/import-vanilla-eclipse.jpg)

3.  In the next Window, select /FreeRTOS/Demo/CORTEX\_MPS2\_QEMU\_IAR\_GCC/build/gcc as the root directory, check the FreeRTOSDemo project, and crucially ensure the "Copy projects into workspace" checkbox is **unchecked**, before clicking the Finish button to bring the project into Eclipse. ![]({{ site.baseurl }}/public/images/import-project-vanilla-eclipse.jpg)

4.  Open main.c, and set mainCREATE\_SIMPLE\_BLINKY\_DEMO\_ONLY to generate either the [simply blinky demo](https://www.freertos.org/a00102.html#simple_blinky_demo), or the [comprehensive test and demo](https://www.freertos.org/a00102.html#comprehensive_demo) application, as required.
    
5.  Select '**Build All**' from the Eclipse '**Project**' menu. A successful build creates the elf file FreeRTOS/Demo/CORTEX\_MPS2\_QEMU\_IAR\_GCC/build/gcc/output/RTOSDemo.out.
    
6.  Ensure QEMU is installed on your host computer. Open a command prompt then start QEMU with the command line just like above.
   
7.  Click the little arrow next to the green bug speed button, then select "Debug Configurations..." from the resultant menu.
![]({{ site.baseurl }}/public/images/debug-configurations-vanilla-eclipse.jpg)
    
    
8.  In the debug configurations window, select "FreeRTOSDemo Default" from under "GDB Hardware Debugging", then click the Debug button. The Eclipse debugger should create a GDB connection to QEMU, start a debug session, and break on entry to the main() function.
![]({{ site.baseurl }}/public/images/debug-configuration-selected-vanilla-eclipse.jpg)
    
For any further information please refer to [https://www.freertos.org/freertos-on-qemu-mps2-an385-model.html](https://www.freertos.org/freertos-on-qemu-mps2-an385-model.html). See also the FAQ [My application does not run, what could be wrong?](https://www.freertos.org/FAQHelp.html), noting in particular the recommendation to develop with [configASSERT()](https://www.freertos.org/a00110.html#configASSERT) defined in FreeRTOSConfig.h and [configCHECK\_FOR\_STACK\_OVERFLOW](https://www.freertos.org/Stacks-and-stack-overflow-checking.html) set to 2.  

Zip your answers (screenshots and descriptions for the demo and gdb connection) file into a file named _yourID\_l08.zip_. Upload this zip file to the Chaoxing Space.
* * *